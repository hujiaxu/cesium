<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium 电流效果示例</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.88/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.88/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <script>
        // 初始化 Cesium Viewer
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            baseLayerPicker: false
        });

        // 自定义 PolylineTrailMaterialProperty
        function PolylineTrailMaterialProperty(color, duration) {
            this._definitionChanged = new Cesium.Event();
            this.color = color;
            this.duration = duration;
            this._time = performance.now();
        }

        Object.defineProperties(PolylineTrailMaterialProperty.prototype, {
            isConstant: { get: function() { return false; } },
            definitionChanged: { get: function() { return this._definitionChanged; } }
        });

        PolylineTrailMaterialProperty.prototype.getType = function() {
            return 'PolylineTrail';
        };

        PolylineTrailMaterialProperty.prototype.getValue = function(time, result) {
            // if (!result) {
            //     result = {};
            // }
            // result.color = Cesium.Property.getValueOrClonedDefault(this.color, time, Cesium.Color.WHITE, result.color);
            // result.time = ((performance.now() - this._time) % this.duration) / this.duration;
            // return result;


            if (!Cesium.defined(result)) {
                result = {};
            }
            result.time = (((new Date()).getTime() - this._time) % this.duration) / this.duration;
            result.color = Cesium.Property.getValueOrDefault(this._color, time, Cesium.Color.WHITE, result.color);
            // result.color = Cesium.Property.getValueOrClonedDefault(this._color, time, Cesium.Color.WHITE, result.color);
            result.image = this.image;
            return result;

        };

        PolylineTrailMaterialProperty.prototype.equals = function(other) {
            return this === other || 
                   (other instanceof PolylineTrailMaterialProperty &&
                    Cesium.Property.equals(this.color, other.color) &&
                    this.duration === other.duration);
        };

        // 自定义着色器
        Cesium.Material.PolylineTrailType = 'PolylineTrail';
        Cesium.Material.PolylineTrailSource = `
            czm_material czm_getMaterial(czm_materialInput materialInput)
            {
                czm_material material = czm_getDefaultMaterial(materialInput);
                vec2 st = materialInput.st;
                float alpha = abs(sin((st.s + czm_frameNumber * 0.01) * 3.14159265359));
                material.diffuse = vec3(0.0, 0.0, 0.0);  // 黑色电缆
                material.emission = vec3(1.0, 1.0, 1.0) * alpha;  // 白色电流
                material.alpha = 1.0;  // 确保电缆完全不透明
                return material;
            }
        `;

        Cesium.Material._materialCache.addMaterial(Cesium.Material.PolylineTrailType, {
            fabric: {
                type: Cesium.Material.PolylineTrailType,
                uniforms: {
                    color: new Cesium.Color(1.0, 0.0, 0.0, 1.0),
                    time: 0
                },
                source: Cesium.Material.PolylineTrailSource
            },
            translucent: function(material) {
                return true;
            }
        });

        // 定义电缆的路径
        const positions = Cesium.Cartesian3.fromDegreesArrayHeights([
            -115.0, 37.0, 1000,
            -115.0, 38.0, 1000,
            -116.0, 38.0, 1000,
            -116.0, 37.0, 1000
        ]);

        // 创建贴地线
        const polyline = viewer.entities.add({
            polyline: {
                positions: positions,
                width: 5,
                material: new PolylineTrailMaterialProperty(Cesium.Color.RED, 100)
            }
        });

        // 设置视角
        viewer.zoomTo(viewer.entities);

    </script>
</body>
</html>
